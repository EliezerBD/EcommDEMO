# ========================================
# Docker Compose para E-commerce Catalog Service
# ========================================
version: '3.8'

services:
  # ========================================
  # Servicio: PostgreSQL Database
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: ecommerce-catalog-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: ecommerce_catalogo
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password

    ports:
      - "5433:5432"

    volumes:
      # Persistir datos de la BD
      - postgres-data:/var/lib/postgresql/data
      # Script de inicialización (opcional)
      # - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql

    networks:
      - catalog-network

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user -d ecommerce_catalogo" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Servicio: Spring Boot Application
  # ========================================
  catalog-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: ecommerce-catalog-service-v2:latest
    container_name: ecommerce-catalog-service
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy

    environment:
      # Perfil de Spring
      SPRING_PROFILES_ACTIVE: dev

      # Configuración de Base de Datos
      DB_URL: jdbc:postgresql://postgres:5432/ecommerce_catalogo
      DB_USERNAME: user
      DB_PASSWORD: password

      # Configuración JPA
      JPA_DDL_AUTO: update
      JPA_SHOW_SQL: "true"

      # Puerto del servidor
      SERVER_PORT: 8081

      # Seguridad
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: pass

      # Logging
      LOG_LEVEL: INFO
      SQL_LOG_LEVEL: DEBUG

    ports:
      - "8085:8081"

    networks:
      - catalog-network

    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/actuator/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # Servicio: Frontend (Nginx)
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ecommerce-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    # volumes:  <-- ELIMINADO para evitar problemas de sincronización en Windows
    #   - ./frontend:/usr/share/nginx/html
    #   - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - catalog-service
    networks:
      - catalog-network

# ========================================
# Redes
# ========================================
networks:
  catalog-network:
    driver: bridge

# ========================================
# Volúmenes
# ========================================
volumes:
  postgres-data:
    driver: local
